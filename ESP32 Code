#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "DHT.h"

// --- Network Settings ---
const char* ssid = "Galaxy A14 5G 8BC8"; 
const char* password = "tujhse matlab";
// Ensure this matches your laptop's current Hotspot IP from ipconfig
const String serverUrl = "http://10.145.71.44:5050/api/sync"; 

// --- Hardware Pins ---
#define DHTPIN 4
#define DHTTYPE DHT22 
const int soilPin = 32;
const int lightPin = 34;

const int fanRelay = 13;
const int pumpRelay = 22;
const int misterRelay = 14; 
const int lightRelay = 27; 

DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(115200);
  dht.begin();

  pinMode(fanRelay, OUTPUT);
  pinMode(pumpRelay, OUTPUT);
  pinMode(misterRelay, OUTPUT);
  pinMode(lightRelay, OUTPUT);

  // Initialize all relays to OFF
  // Note: Most relay modules are Active LOW (HIGH = OFF, LOW = ON)
  digitalWrite(fanRelay, HIGH); 
  digitalWrite(pumpRelay, HIGH);
  digitalWrite(misterRelay, HIGH);
  digitalWrite(lightRelay, HIGH);

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n✅ WiFi Connected!");
  Serial.print("IP Address: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  if (WiFi.status() == WL_CONNECTED) {
    // 1. READ SENSORS
    float h = dht.readHumidity();
    float t = dht.readTemperature();
    
    // Soil Moisture Mapping (4095 is dry, 0 is wet)
    int s = map(analogRead(soilPin), 4095, 0, 0, 100);
    s = constrain(s, 0, 100);

    // Sunlight Mapping (0 is dark, 4095 is bright)
    int l = map(analogRead(lightPin), 0, 4095, 0, 100);
    l = constrain(l, 0, 100);

    if (isnan(h) || isnan(t)) {
      Serial.println(F("❌ DHT Sensor Error!"));
      delay(2000);
      return;
    }

    // 2. PREPARE DATA (Variable names match Dashboard.tsx exactly)
    StaticJsonDocument<256> doc;
    doc["temperature"] = t;
    doc["humidity"] = h;
    doc["soil"] = s;
    doc["light"] = l;

    String jsonString;
    serializeJson(doc, jsonString);

    // 3. SEND TO BACKEND
    HTTPClient http;
    http.begin(serverUrl);
    http.addHeader("Content-Type", "application/json");

    int httpResponseCode = http.POST(jsonString);

    if (httpResponseCode > 0) {
      String response = http.getString();
      StaticJsonDocument<768> resDoc;
      deserializeJson(resDoc, response);

      // 4. RECEIVE CONFIGURATION
      bool override = resDoc["config"]["override"];
      bool fanStatus = resDoc["config"]["fanStatus"];
      bool pumpStatus = resDoc["config"]["pumpStatus"];
      bool mistStatus = resDoc["config"]["misterStatus"];
      bool uvStatus = resDoc["config"]["lightStatus"];
      
      float tLimit = resDoc["config"]["tempLimit"];
      int sLimit = resDoc["config"]["soilLimit"]; 
      int hLimit = resDoc["config"]["humidityLimit"];
      int lLimit = resDoc["config"]["sunlightLimit"];

      // 5. ACTUATION LOGIC
      // Manual Mode: Follow Dashboard Switches
      if (override) {
        digitalWrite(fanRelay, fanStatus ? LOW : HIGH);
        digitalWrite(pumpRelay, pumpStatus ? LOW : HIGH);
        digitalWrite(misterRelay, mistStatus ? LOW : HIGH);
        digitalWrite(lightRelay, uvStatus ? LOW : HIGH);
        Serial.println("MODE: MANUAL OVERRIDE");
      } 
      // Auto Mode: Follow Threshold Sliders
      else {
        digitalWrite(fanRelay, (t > tLimit) ? LOW : HIGH);
        digitalWrite(pumpRelay, (s < sLimit) ? LOW : HIGH);
        digitalWrite(misterRelay, (h < hLimit) ? LOW : HIGH);
        digitalWrite(lightRelay, (l < lLimit) ? LOW : HIGH);
        Serial.println("MODE: AUTOMATIC");
      }

      Serial.printf("SENT >> T:%.1f H:%.1f S:%d%% L:%d%%\n", t, h, s, l);

    } else {
      Serial.printf("❌ Sync Error: %d\n", httpResponseCode);
    }
    http.end();
  }
  delay(5000); // Wait 5 seconds for next sync
}
